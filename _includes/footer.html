<script>
(function () {
  const KEY = "site_lang";

  function normalizeLang(lang) {
    if (!lang) return null;
    lang = lang.toLowerCase();
    if (lang.startsWith("ja")) return "jp";
    if (lang.startsWith("en")) return "en";
    if (lang.startsWith("zh")) return "zh";
    return null;
  }

  function applyLang(lang) {
    document.querySelectorAll(".lang").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".lang-" + lang).forEach(el => el.classList.add("active"));
    localStorage.setItem(KEY, lang);

    document.querySelectorAll(".lang-link").forEach(a => {
      a.classList.toggle("active", a.dataset.lang === lang);
    });

    if (window.MathJax && window.MathJax.typesetPromise) {
      MathJax.typesetPromise();
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const saved = normalizeLang(localStorage.getItem(KEY));
    const auto = "en";
    const lang = saved || auto;
    applyLang(lang);

    document.querySelectorAll(".lang-link").forEach(a => {
      a.addEventListener("click", e => {
        e.preventDefault();
        applyLang(a.dataset.lang);
      });
    });
  });
})();
</script>
